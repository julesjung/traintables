name: Update Database

on:
  schedule:
   - cron: "0 0 * * *"

  workflow_dispatch:

jobs:
  update-stops-database:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          rust-src-dir: gtfs
      - run: cargo run --manifest-path=gtfs/Cargo.toml
      - env:
          PGPASSWORD: ${{ secrets.DATABASE_PASSWORD }}
        run: |
          psql -h aws-1-eu-west-1.pooler.supabase.com -p 5432 -d postgres -U postgres.ifeuhrjcyxcxekfhstle <<EOF
          BEGIN;
          SET session_replication_role = replica;

          TRUNCATE 
            stop_times,
            trips,
            routes,
            service_days,
            services,
            stops,
            stations
          CASCADE;

          \COPY stations FROM 'build/stations.csv' CSV HEADER;
          \COPY stops FROM 'build/stops.csv' CSV HEADER;
          \COPY services FROM 'build/services.csv' CSV HEADER;
          \COPY service_days FROM 'build/service_days.csv' CSV HEADER;
          \COPY routes FROM 'build/routes.csv' CSV HEADER;
          \COPY trips FROM 'build/trips.csv' CSV HEADER;
          \COPY stop_times FROM 'build/stop_times.csv' CSV HEADER;

          SET session_replication_role = DEFAULT;
          COMMIT;
          EOF